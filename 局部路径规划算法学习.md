自动驾驶规划的目标：算出一条满足约束的最优轨迹，平滑性，舒适性，尽可能短，耗时少。

衡量轨迹质量往往用cost function

# 局部路径规划算法学习

- 基于曲线拟合的算法：圆弧与直线、多项式曲线、样条曲线、贝塞尔曲线、微分平分
- 基于数值优化的算法：利用目标函数和约束对规划问题进行描述和求解

## 1. lattice Planner规划算法

lattice planner是直接高维轨迹规划（路径和车速一起规划）

Lattice Planner算法属于一种局部轨迹规划器，输出轨迹将直接输入到控制器，由控制器完成对局部轨迹的跟踪控制

**算法思路**：

1. 将车辆当前位姿信息转换到frenet坐标系下，获得车辆在frenet坐标系的初始状态；根据当前速度计算前瞻距离，获得前瞻点，获得车辆在前瞻点位置frenet坐标系下的目标状态。
2. 对轨迹状态进行采样，分别是轨迹运行时间t，目标速度v，及到参考线的横向位移d，通过这三个规划参数可以获得采样状态。
3. 构建横向位移和纵向位移的多项式规划函数s(t)，d(s)，获得横向位移和纵向位移的规划函数后，进行时间插值就可以获得参考线frenet坐标系下的轨迹点，最后将轨迹点从frenet坐标系转换到cartesian坐标系，就可以获得物理世界采样轨迹，由于横向和纵向都是通过高次多项式插值获得，以此cartesian坐标系下的轨迹也是光滑的。
4. 采样轨迹的碰撞检测、曲率约束及最优轨迹打分。采样轨迹是一系列满足速度约束的光滑轨迹，但其还需要满足无碰撞和车辆运动学曲率约束的强制约束，及远离障碍物和靠近参考线等组成的代价约束。采样轨迹的打分就是为了获得一条最优的满足约束条件的无碰撞光滑轨迹。该轨迹也是lattice输出到controller用于车辆跟随的轨迹。

将坐标点转换到frenet坐标系的**目的**则是为了方便规划曲线的生成和车道线横向和纵向方向上的轨迹采样，从而获得覆盖整个车道的光滑采样轨迹。

Lattice规划器的轨迹采样，主要分为横向采样、纵向采样以及轨迹时间周期采样。 横向轨迹的采样需要涵盖多种横向运动状态，需要根据车道宽度设置横向采样的采样区间，通过横向采样间隔，形成不同的横向采样偏移量。纵向采样的采样区间可以通过前瞻点的位移长度s，作为基准采样长度，然后通过对轨迹速度ds进行采样。时间周期采样，就是对轨迹的运行周期时间进行采样。而百度Apollo的轨迹采样，只对横向位移和纵向位移进行了采样，并设计了采样状态横向偏移量，-0.5，0.0和0.5，以及四个到达这些横向偏移量的纵向位移，分别为10，20，40，80来得到采样状态。所以Lattice规划器的轨迹采样主要是对轨迹横纵向状态进行采样，但采样方式可以根据环境情况进行调整。

lattice planner速度规划

有了前面的采样状态，现在需要做的是根据采样状态生成横向l(s)和纵向s(t)和规划函数，两种规划函数都是通过多项式进行拟合求解生成。主要使用了4次和5次多項式拟合，从而满足了车辆运行过程中的一阶导，二阶导连续，也就是速度和加速度连续，保证了轨迹的平滑性要求。

对于纵向轨迹s(t)，在停车和跟车状态，都是五次多项式，但对于巡航状态，由于我们不需要确定状态的S值，所以只有五个变量，因此用四次多项式就可以了。对于横向轨迹l(s)也使用了五次多项式拟合。

这里规划器的采样方式没有使用Apollo中Lattice的横纵向采样方式，而是采用了上文中提到的采样方式，因此约束变量有：

## 2. EM Planner 规划算法

EM planner是路径和车速分层规划。

在规划过程中解决决策问题。一般先是由rounting模块进行全局规划，得出reference line，然后motion planning在此基础上进行局部轨迹规划。motion planning将路径和车速分层规划，并在SL和ST坐标系下，使用动态规划进行路径和车速的决策和粗规划，然后使用二次规划进行平滑处理。

<img src="https://img-blog.csdnimg.cn/2021030510011038.JPG?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0lIVFlfTlVJ,size_16,color_FFFFFF,t_70#pic_center" alt="img" style="zoom:67%;" />

动态规划：使用动态规划的原因是Apollo把道路进行切片撒点，把轨迹问题变成分段最优问题，即动态规划中的最优子结构。

​		一般复杂函数在复杂约束下的最小值问题用迭代法，如EM用梯度下降法

​		求凸函数在凸空间的最小值问题称为凸优化。

二次规划：使用二次规划的原因是Apollo把路径和车速平滑性，以平方项的方式进行量化，由此转化为二次规划问题。

非凸空间 → 离散化→ 粗解 → 迭代 → 最优解



lattice planner和EM planner的区别：

Lattice主要是采样和剪枝的思想，EM主要是优化的思想。二者的目标都是求取代价最小的路径。

lattice planner 计算出多条轨迹，然后对每条轨迹进行评估，最终得出最优轨迹。

EM Planner 将轨迹规划分为2部分优化：path即d-s，speed即s-t，优化分为2个步骤：DP动态规划求大致解，更像是给出nudge or overtake这样的决策，把优化问题变为凸优化问题，为后续的QP二次规划提供参考。QP则求精细的平滑的轨迹。

## 3. RTK Planner 规划算法

RTK planner是基于录制的轨迹规划行车路线

## 4.TEB算法

**定义：**起始点、目标点状态由用户/全局规划器指定，中间插入N个控制橡皮筋形状的控制点，每两个姿态点之间定义一个时间(等时间间隔即时间分辨率)，这个路径可以变形，变形的条件就是所有约束当作橡皮筋的外力。注意，每个目标函数只与elastic band中的某几个连续状态有关，而非整条band。

约束目标函数（常见有四种）：

- 跟随路径+避障

​			跟随路径可以看作施力将橡皮筋拉向全局路径，而避障约束看作施力使elastic band远离障碍物

- 速度/加速度约束

​			两姿态点（x，y，θ）之间，直接用差分近似计算

![img](https://latex.codecogs.com/gif.latex?V_%7Bmin%7D%20%5Cleqslant%20f_%7Bv%7D%28B%29%20%5Cleqslant%20V_%7Bmax%7D)

![img](https://latex.codecogs.com/gif.latex?a_%7Bmin%7D%20%5Cleqslant%20f_%7Ba%7D%28B%29%20%5Cleqslant%20a_%7Bmax%7D)

- 运动学约束

​			若干弧段组成的平滑轨迹，(最小转弯半径)

- 最快路径约束（区别于最短路径）

​			

TEB优化问题：

​	TEB是一个多目标优化的问题，大多数目标都是局部的，故只与一小部分参数相关。因此它只依赖于几个连续的机器人状态。

​	优化算法：开源框架 g2o ：点（node）和边（edge），通用图优化法

## 5.DWA算法（动态窗口法）

